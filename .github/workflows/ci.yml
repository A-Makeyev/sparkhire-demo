name: CI Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore

      - name: Run tests
        run: dotnet test --no-build --verbosity normal
        env:
          BASE_URL: ${{ secrets.BASE_URL || 'https://www.comeet.com' }}
          CHROME_HEADLESS: true
          GITHUB_RUN_NUMBER: ${{ github.run_number }}

      - name: Download previous reports from gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: old-reports

      - name: Prepare reports - merge, prune old, generate index
        if: always()
        run: |
          mkdir -p Results

          # Copy previous reports (if gh-pages exists)
          if [ -d "old-reports" ]; then
            cp -rn old-reports/Run-* Results/ 2>/dev/null || true
          fi

          # Your new report should already be in ./Results/Run-... from the test step
          # If it's generated elsewhere, add: mv path/to/new-report Results/

          cd Results

          # Keep only the newest 10 reports
          # Your naming (Run-N_YYYY-MM-DD_HH-MM-SS) sorts correctly with plain sort -r
          ls -d Run-* 2>/dev/null | sort -r | tail -n +11 | xargs -r rm -rf

          # Generate index.html - newest reports first
          {
            echo "<!DOCTYPE html>"
            echo "<html lang=\"en\">"
            echo "<head>"
            echo "  <meta charset=\"UTF-8\">"
            echo "  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">"
            echo "  <title>Sparkhire Test Reports</title>"
            echo "  <style>"
            echo "    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px; background: #f8f9fa; color: #333; line-height: 1.6; }"
            echo "    h1 { color: #2c3e50; text-align: center; margin-bottom: 2rem; }"
            echo "    ul { list-style: none; padding: 0; max-width: 900px; margin: 0 auto; }"
            echo "    li { background: white; margin: 12px 0; padding: 18px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.1s; }"
            echo "    li:hover { transform: translateY(-2px); }"
            echo "    a { text-decoration: none; color: #0066cc; font-weight: 500; display: flex; align-items: center; gap: 12px; font-size: 1.1rem; }"
            echo "    a:hover { color: #004080; }"
            echo "    .emoji { font-size: 1.5em; }"
            echo "  </style>"
            echo "</head>"
            echo "<body>"
            echo "  <h1>üß™ Sparkhire Test Reports</h1>"
            echo "  <ul>"

            for dir in $(ls -d Run-* 2>/dev/null | sort -r); do
              echo "    <li><a href=\"./$dir/index.html\"><span class=\"emoji\">üìÅ</span> $dir</a></li>"
            done

            echo "  </ul>"
            echo "</body>"
            echo "</html>"
          } > index.html

          cd ..

      - name: Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./Results
          publish_branch: gh-pages
          force_orphan: true
